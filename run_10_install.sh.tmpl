#!/bin/bash

brew bundle --file=/dev/stdin <<EOF
{{ range .packages.darwin.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF

UNDERCOVER_FILE="$HOME/.topsecretfbiundercover"
touch $UNDERCOVER_FILE
chmod 600 $UNDERCOVER_FILE

# git
git config --global core.excludesfile "$HOME/.global_gitignore"
git config --global user.useConfigOnly true
git config --global push.autoSetupRemote true
git config --global gpg.format "ssh"

## force user config to be per repository
git config --global --unset user.name
git config --global --unset user.email
git config --global --unset user.signingkey

## force lf everywhere
git config --global core.autocrlf false
git config --global core.eol lf

## aliases
git config --global alias.pushall '!git remote | xargs -L1 git push'
git config --global alias.oldest-ancestor '!bash -c '\''diff --old-line-format='' --new-line-format='' <(git rev-list --first-parent "${1:-master}") <(git rev-list --first-parent "${2:-HEAD}") | head -1'\'' -' # https://stackoverflow.com/a/4991675/10559526
git config --global alias.pushfwl "push --force-with-lease"

# gitlab-search
echo "Checking gitlab-search installation..."
GITLAB_SEARCH_DIR="$HOME/.local/node/gitlab-search"
BIN_DEST="$HOME/.local/bin/gitlab-search"
mkdir -p "$GITLAB_SEARCH_DIR"
mkdir -p "$HOME/.local/bin"

(
    cd "$GITLAB_SEARCH_DIR"
    if [ ! -f package.json ]; then
        echo "Initializing gitlab-search home..."
        npm init -y > /dev/null
    fi
    echo "Updating gitlab-search to latest..."
    npm install gitlab-search@latest --quiet --no-progress
)

echo "Creating gitlab-search wrapper..."
cat <<EOF > "$BIN_DEST"
#!/bin/bash
# Wrapper generated by chezmoi to automate config location
if [[ "\$1" == "setup" ]]; then
    exec "$GITLAB_SEARCH_DIR/node_modules/.bin/gitlab-search" "\$@" --dir "\$HOME"
else
    exec "$GITLAB_SEARCH_DIR/node_modules/.bin/gitlab-search" "\$@"
fi
EOF
chmod +x "$BIN_DEST"
echo "gitlab-search is ready! Run 'gitlab-search setup <token>' to configure (saves to ~/.gitlabsearchrc)"
